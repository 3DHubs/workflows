name: tf-lint

on:
  workflow_call:
    inputs:
      path:
        description: "Path to directory containing Terraform code"
        type: string
        required: true
      aws_region:
        description: "AWS region to use"
        type: string
        required: true
      terraform_version:
        description: "Terraform version"
        type: string
        required: false
        default: '0.14.4'

jobs:
  lint:
    runs-on: ubuntu-latest
    name: Lint Terraform
    defaults:
      run:
        working-directory: ${{ inputs.path }}
    env:
      AWS_REGION: ${{ inputs.aws_region }}
    steps:
      - uses: actions/checkout@v2

      - uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: fmt
        run: terraform fmt -check -recursive

      - name: validate
        env:
          default_branch: ${{ github.event.repository.default_branch }}
        run: |
          git fetch origin --quiet

          git diff --name-only --diff-filter=d "origin/$default_branch" \
          | grep '\.tf$' \
          | xargs -n1 dirname \
          | sort -u \
          | while read -r dir; do
            echo -e "\n$dir -----------------------------------"
            cd "$dir"
              terraform init -backend=false >/dev/null
              terraform validate -no-color
            cd -
          done
